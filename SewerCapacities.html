<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sanitary Sewer Capacity Scenarios</title>

  <!-- ArcGIS Maps SDK for JavaScript (CDN) -->
  <link rel="stylesheet" href="https://js.arcgis.com/4.34/esri/themes/light/main.css" />
  <script src="https://js.arcgis.com/4.34/"></script>

  <style>
    html, body, #viewDiv { height: 100%; width: 100%; margin: 0; padding: 0; }

    #topbar {
      position: absolute;
      top: 10px; left: 10px;
      z-index: 10;
      background: white;
      padding: 10px 12px;
      border-radius: 10px;
      box-shadow: 0 2px 12px rgba(0,0,0,.18);
      display: flex;
      gap: 10px;
      align-items: center;
      font-family: Arial, sans-serif;
      max-width: calc(100vw - 20px);
    }

    #scenarioWrap {
      display: flex;
      gap: 8px;
      align-items: center;
      min-width: 220px;
    }

    #scenarioLabel {
      white-space: nowrap;
      font-weight: 600;
      font-size: 13px;
    }

    #scenarioSelect {
      width: 260px;
      max-width: 55vw;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #cfcfcf;
      background: #fff;
      font-size: 14px;
    }

    button {
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid #cfcfcf;
      background: #f7f7f7;
      cursor: pointer;
    }

    button:hover { background: #efefef; }

    #status {
      font-size: 12px;
      color: #555;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 34vw;
    }

    @media (max-width: 520px) {
      #scenarioLabel { display: none; }
      #scenarioSelect { width: 210px; }
      #status { display: none; }
    }
  </style>
</head>

<body>
  <!-- Top bar UI -->
  <div id="topbar">
    <button id="signInBtn">Sign in</button>
    <button id="signOutBtn" style="display:none;">Sign out</button>

    <div id="scenarioWrap" style="display:none;">
      <span id="scenarioLabel">Scenario:</span>
      <select id="scenarioSelect" disabled>
        <option>Loading…</option>
      </select>
    </div>

    <span id="status">Not signed in</span>
  </div>

  <!-- Map -->
  <div id="viewDiv"></div>

  <script>
    require([
      "esri/config",
      "esri/portal/Portal",
      "esri/identity/OAuthInfo",
      "esri/identity/IdentityManager",
      "esri/WebMap",
      "esri/views/MapView",
      "esri/widgets/Legend",
      "esri/widgets/Measurement",
      "esri/widgets/Print",
      "esri/widgets/Expand"
    ], function (
      esriConfig, Portal, OAuthInfo, esriId,
      WebMap, MapView,
      Legend, Measurement, Print, Expand
    ) {

      // ====== YOUR SETTINGS ======
      const WEBMAP_ID = "7bd7b027df024f7c9b8c6b9be002bf3a";
      const EXCLUSIVE_GROUP_TITLE = "Sanitary Sewer Capacity Scenarios";

      // ✅ Paste your ArcGIS Online OAuth "Client ID" here:
      const CLIENT_ID = "PASTE_YOUR_CLIENT_ID_HERE";

      // If your org uses a custom domain, use it (recommended), e.g. https://yourorg.maps.arcgis.com
      // If not sure, keep https://www.arcgis.com
      const PORTAL_URL = "https://emht.maps.arcgis.com";
      // ===========================

      esriConfig.portalUrl = PORTAL_URL;

      // UI elements
      const signInBtn = document.getElementById("signInBtn");
      const signOutBtn = document.getElementById("signOutBtn");
      const statusEl = document.getElementById("status");
      const scenarioWrap = document.getElementById("scenarioWrap");
      const scenarioSelect = document.getElementById("scenarioSelect");

      let view = null;
      let groupLayer = null;
      let scenarioChangeHandlerAttached = false;

      function setSignedOutUI() {
        statusEl.textContent = "Not signed in";
        signInBtn.style.display = "inline-block";
        signOutBtn.style.display = "none";
        scenarioWrap.style.display = "none";
        scenarioSelect.disabled = true;
      }

      function setSignedInUI(username) {
        statusEl.textContent = `Signed in as ${username}`;
        signInBtn.style.display = "none";
        signOutBtn.style.display = "inline-block";
        scenarioWrap.style.display = "flex";
      }

      function clearScenarioSelect(msg = "Loading…") {
        scenarioSelect.innerHTML = "";
        const opt = document.createElement("option");
        opt.textContent = msg;
        opt.value = "";
        scenarioSelect.appendChild(opt);
        scenarioSelect.value = "";
        scenarioSelect.disabled = true;
      }

      function populateScenarioDropdownFromGroup(group) {
        scenarioSelect.innerHTML = "";

        group.layers.forEach((layer, idx) => {
          const opt = document.createElement("option");
          opt.value = String(idx);
          opt.textContent = layer.title || `Scenario ${idx + 1}`;
          scenarioSelect.appendChild(opt);
        });

        // Ensure one is visible; pick first visible or default to 0
        let visibleIndex = group.layers.findIndex(l => l.visible);
        if (visibleIndex === -1) visibleIndex = 0;

        group.layers.forEach((layer, i) => {
          layer.visible = (i === visibleIndex);
        });

        scenarioSelect.value = String(visibleIndex);
        scenarioSelect.disabled = false;

        // Attach handler once
        if (!scenarioChangeHandlerAttached) {
          scenarioSelect.addEventListener("change", () => {
            if (!groupLayer) return;
            const selectedIndex = Number(scenarioSelect.value);

            groupLayer.layers.forEach((layer, i) => {
              layer.visible = (i === selectedIndex);
            });
          });
          scenarioChangeHandlerAttached = true;
        }
      }

      async function loadMapAndUI() {
        // Build webmap + view
        const webmap = new WebMap({
          portalItem: { id: WEBMAP_ID }
        });

        // Destroy existing view if reloading
        if (view) {
          view.destroy();
          view = null;
        }

        view = new MapView({
          container: "viewDiv",
          map: webmap
        });

        // Add widgets (Legend, Measurement, Print) in expandable panels
        const legend = new Legend({ view });
        const measurement = new Measurement({ view });

        const print = new Print({
          view,
          printServiceUrl:
            "https://utility.arcgisonline.com/arcgis/rest/services/Utilities/PrintingTools/GPServer/Export%20Web%20Map%20Task"
        });

        view.ui.add(new Expand({ view, content: legend, expanded: false }), "top-left");
        view.ui.add(new Expand({ view, content: measurement, expanded: false }), "top-left");
        view.ui.add(new Expand({ view, content: print, expanded: false }), "top-left");

        // Wait for map/view
        await view.when();
        await webmap.load();

        // Find the scenario group layer
        groupLayer = webmap.allLayers.find((lyr) =>
          lyr.type === "group" && lyr.title === EXCLUSIVE_GROUP_TITLE
        );

        if (!groupLayer) {
          clearScenarioSelect(`Group not found: ${EXCLUSIVE_GROUP_TITLE}`);
          console.warn(`Group layer "${EXCLUSIVE_GROUP_TITLE}" not found. Check the exact title in the Web Map.`);
          return;
        }

        // Populate dropdown with the group's children
        populateScenarioDropdownFromGroup(groupLayer);
      }

      async function getUsername() {
        const portal = new Portal();
        portal.authMode = "immediate";
        await portal.load();
        return portal?.user?.username || "user";
      }

      // OAuth setup
      const info = new OAuthInfo({
        appId: CLIENT_ID,
        portalUrl: PORTAL_URL,
        popup: true
      });
      esriId.registerOAuthInfos([info]);

      async function trySilentSignIn() {
        try {
          // If a session exists, this succeeds without prompting
          await esriId.checkSignInStatus(PORTAL_URL + "/sharing");
          const username = await getUsername();
          setSignedInUI(username);

          clearScenarioSelect("Loading…");
          await loadMapAndUI();
        } catch (e) {
          setSignedOutUI();
          clearScenarioSelect("Sign in to select scenarios");
          // console.log("Silent sign-in not available.", e);
        }
      }

      signInBtn.addEventListener("click", async () => {
        try {
          await esriId.getCredential(PORTAL_URL + "/sharing");
          const username = await getUsername();
          setSignedInUI(username);

          clearScenarioSelect("Loading…");
          await loadMapAndUI();
        } catch (e) {
          console.error("Sign-in failed:", e);
          alert("Sign-in failed. Check your Client ID and that Redirect URIs include your GitHub page URL exactly.");
        }
      });

      signOutBtn.addEventListener("click", () => {
        esriId.destroyCredentials();
        setSignedOutUI();
        clearScenarioSelect("Sign in to select scenarios");

        if (view) {
          view.destroy();
          view = null;
        }
        groupLayer = null;
      });

      // Initial load
      setSignedOutUI();
      clearScenarioSelect("Sign in to select scenarios");
      trySilentSignIn();
    });
  </script>
</body>
</html>
