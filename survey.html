<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Website Survey</title>

  <style>
    html, body { height: 100%; margin: 0; }
    #statusBar {
      height: 52px;
      padding: 10px 14px;
      font-family: Arial, sans-serif;
      background: #ffffff;
      box-shadow: 0 1px 8px rgba(0,0,0,0.15);
      position: sticky;
      top: 0;
      z-index: 10;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    #statusLeft { display: flex; flex-direction: column; gap: 2px; }
    #statusTitle { font-weight: 700; }
    #statusMsg { font-size: 12px; opacity: 0.8; }
    #statusPill {
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      background: #f2f2f2;
      white-space: nowrap;
    }
    #formDiv { height: calc(100% - 52px); }
  </style>

  <!-- Survey123 Web App JavaScript API -->
  <script src="https://survey123.arcgis.com/api/jsapi/"></script>
</head>

<body>
  <div id="statusBar">
    <div id="statusLeft">
      <div id="statusTitle">Ready</div>
      <div id="statusMsg">Please complete the form and submit.</div>
    </div>
    <div id="statusPill">Not submitted</div>
  </div>

  <div id="formDiv"></div>

  <script>
    const SURVEY_ITEM_ID = "d4f003f5be254f9bb5a8d92a281f9e13";
    const RESULT_PAGE = "https://aburg55.github.io/testPage.html";

    const statusTitle = document.getElementById("statusTitle");
    const statusMsg   = document.getElementById("statusMsg");
    const statusPill  = document.getElementById("statusPill");

    function setStatus(title, msg, pill) {
      statusTitle.textContent = title;
      statusMsg.textContent = msg || "";
      statusPill.textContent = pill || "";
    }

    const webform = new Survey123WebForm({
      container: document.getElementById("formDiv"),
      itemId: SURVEY_ITEM_ID
    });

    // Optional: live validation feedback (won't block submit, but helps users)
    // (API supports these events) :contentReference[oaicite:1]{index=1}
    webform.setOnQuestionValidated((info) => {
      // info shape can vary; we keep this gentle and non-breaking.
      // If you want, paste a console.log(info) once and we can make it smarter.
    });

    webform.setOnFormSubmit(() => {
      console.log("onFormSubmit fired");
      setStatus("Submitting…", "Please wait—saving your response.", "Submitting");
    });

    // Prevent double redirects
    let redirected = false;

    webform.setOnFormSubmitted((data) => {
      console.log("onFormSubmitted fired. Data:", data);

      if (redirected) return;

      // Pull IDs + geometry from the payload shape you saw
      const feature = data?.surveyFeatureSet?.features?.[0];
      const attrs = feature?.attributes || {};
      const geom  = feature?.geometry || null;

      const addRes = data?.result?.[0]?.addResults?.[0] || {};

      const globalId =
        attrs.globalid || attrs.GlobalID || attrs.GLOBALID ||
        addRes.globalId || addRes.globalID || addRes.GlobalID;

      const objectId =
        attrs.objectid || attrs.OBJECTID ||
        addRes.objectId || addRes.objectID || addRes.objectid;

      console.log("Extracted:", { globalId, objectId, hasGeometry: !!geom });

      // If geometry is missing, give the user a clear message.
      // (This typically means the location wasn't actually set.)
      if (!geom) {
        setStatus(
          "Submitted — but location missing",
          "It looks like the point location did not save. Please submit again and make sure you place/select the point on the map question.",
          "Needs location"
        );
        return;
      }

      setStatus("Submitted!", "Redirecting to your map…", "Redirecting");

      redirected = true;

      // Prefer GlobalID (best for per-user accuracy)
      if (globalId) {
        window.location.assign(`${RESULT_PAGE}?gid=${encodeURIComponent(globalId)}`);
        return;
      }

      // Fallback: OBJECTID
      if (Number.isFinite(Number(objectId))) {
        window.location.assign(`${RESULT_PAGE}?oid=${encodeURIComponent(objectId)}`);
        return;
      }

      // If we can't redirect, allow another attempt
      redirected = false;
      setStatus(
        "Submitted — but missing ID",
        "The form submitted, but no ID was returned to the embed page. Open the console and share the logged data object.",
        "Error"
      );
    });
  </script>
</body>
</html>
