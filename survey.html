<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Address Submission</title>

  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      background: #ffffff;
      font-family: -apple-system, system-ui, Segoe UI, Roboto, Arial, sans-serif;
    }

    #statusBar {
      position: fixed;
      left: 12px;
      right: 12px;
      bottom: calc(12px + env(safe-area-inset-bottom));
      z-index: 9999;
      background: rgba(0,0,0,0.85);
      color: #ffffff;
      padding: 12px 14px;
      border-radius: 14px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.25);
      display: none;
    }

    #statusTitle {
      font-weight: 700;
      font-size: 14px;
      margin-bottom: 4px;
    }

    #statusMsg {
      font-size: 13px;
      opacity: 0.95;
      word-break: break-word;
    }

    #formDiv {
      height: 100%;
    }
  </style>

  <!-- Load Survey123 JavaScript API -->
  <script src="https://survey123.arcgis.com/api/jsapi/"></script>
</head>

<body>

  <div id="formDiv"></div>

  <div id="statusBar">
    <div id="statusTitle"></div>
    <div id="statusMsg"></div>
  </div>

  <script>
    // Survey123 itemId
    const SURVEY_ITEM_ID = "d4f003f5be254f9bb5a8d92a281f9e13";

    // ArcGIS GitHub result page
const RESULT_PAGE = "https://aburg55.github.io/testPage.html";

    // Feature layer that stores submitted points
    const SURVEY_LAYER_URL = "https://services1.arcgis.com/MEvzxYGCHO108ZxL/ArcGIS/rest/services/survey123_d4f003f5be254f9bb5a8d92a281f274f9e13/FeatureServer/0";

    const statusBar = document.getElementById("statusBar");
    const statusTitle = document.getElementById("statusTitle");
    const statusMsg = document.getElementById("statusMsg");

    function showStatus(title, msg) {
      statusTitle.textContent = title || "";
      statusMsg.textContent = msg || "";
      statusBar.style.display = "block";
    }

    function hideStatus() {
      statusBar.style.display = "none";
    }

    const webform = new Survey123WebForm({
      container: document.getElementById("formDiv"),
      itemId: SURVEY_ITEM_ID
    });

    // Triggered when submit button is pressed
    webform.setOnFormSubmit(() => {
      console.log("Submitting survey");
      showStatus("Submitting…", "Saving your address, please wait.");
    });

    let redirected = false;

    // Triggered after successful submission
webform.setOnFormSubmitted((data) => {

  console.log("onFormSubmitted:", data);

  const feature = data?.surveyFeatureSet?.features?.[0];
  const attrs = feature?.attributes || {};
  const geom = feature?.geometry || null;

  // Extract address text from the submitted field
  const address = attrs.enter_your_address_here;

  if (!geom) {
    alert("Submitted, but the address point could not be located. Please try a different address.");
    return;
  }

  // Redirect after a brief moment so user sees confirmation
  setTimeout(() => {
    window.location.assign(`${RESULT_PAGE}?addr=${encodeURIComponent(address)}`);
  }, 1200);

});

      redirected = true;

      showStatus("Submitted!", "Opening map view…");

      // Short delay so user can see the message on mobile
      setTimeout(() => {
        window.location.assign(`${RESULT_PAGE}?addr=${encodeURIComponent(address)}`);
      }, 1200);
    });

  </script>

</body>
</html>
