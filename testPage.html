<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Submission Received</title>

  <link rel="stylesheet" href="https://js.arcgis.com/4.28/esri/themes/light/main.css" />
  <script src="https://js.arcgis.com/4.28/"></script>

  <style>
    html, body, #viewDiv { height: 100%; margin: 0; padding: 0; }
    #panel {
      position: absolute; top: 10px; left: 10px; right: 10px;
      background: rgba(255,255,255,0.95);
      padding: 10px 12px; border-radius: 6px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      font-family: Arial, sans-serif; z-index: 99; font-size: 13px;
      max-height: 28vh; overflow: auto;
    }
    #status { font-weight: 700; margin-bottom: 6px; }
    code { font-family: Consolas, monospace; font-size: 12px; }
  </style>
</head>

<body>
  <div id="panel">
    <div id="status">Loading…</div>
    <div><b>gid:</b> <code id="gid"></code></div>
    <div><b>oid:</b> <code id="oid"></code></div>
    <div><b>where:</b> <code id="where"></code></div>
    <div><b>result:</b> <code id="result"></code></div>
  </div>

  <div id="viewDiv"></div>

  <script>
    require([
      "esri/Map",
      "esri/views/MapView",
      "esri/layers/FeatureLayer"
    ], function (Map, MapView, FeatureLayer) {

      const el = (id) => document.getElementById(id);
      const status = (t) => { el("status").textContent = t; };

      const params = new URLSearchParams(window.location.search);
      let gid = params.get("gid");
      let oid = params.get("oid");

      el("gid").textContent = gid ?? "(null)";
      el("oid").textContent = oid ?? "(null)";

      // Clean gid if present
      if (gid) {
        gid = decodeURIComponent(gid).trim()
          .replace(/^{/, "").replace(/}$/, "")
          .replace(/^'+|'+$/g, "");
      }

      // Validate oid if present
      const oidNum = oid ? Number(oid) : null;

      const looksLikePlaceholder = (s) => s && (s.includes("${") || s.includes("$("));

      // Your GlobalID field name is lowercase "globalid"
      let whereClause = null;
      if (gid && !looksLikePlaceholder(gid)) {
        whereClause = `globalid='${gid}'`;
      } else if (Number.isFinite(oidNum)) {
        whereClause = `objectid=${oidNum}`;
      }

      el("where").textContent = whereClause ?? "(none)";

      const map = new Map({ basemap: "topo-vector" });
      const view = new MapView({ container: "viewDiv", map, zoom: 5 });

      const surveyLayer = new FeatureLayer({
        url: "https://services1.arcgis.com/MEvzxYGCHO108ZxL/arcgis/rest/services/survey123_d4f003f5be254f9bb5a8d92a281f9e13/FeatureServer/0",
        outFields: ["*"],
        opacity: 0.75
      });
      map.add(surveyLayer);

      const MAX_ATTEMPTS = 14;
      const RETRY_DELAY = 700;
      let attempt = 0;
      let highlightHandle = null;

      async function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

      async function findFeature(layer) {
        if (!whereClause) return null;

        while (attempt < MAX_ATTEMPTS) {
          attempt++;
          status(`Finding your submission… (${attempt}/${MAX_ATTEMPTS})`);

          const res = await layer.queryFeatures({
            where: whereClause,
            returnGeometry: true,
            outFields: ["*"]
          });

          el("result").textContent = `features=${res.features?.length ?? 0}`;

          if (res.features && res.features.length > 0) {
            return res.features[0];
          }

          await sleep(RETRY_DELAY);
        }

        return null;
      }

      view.when(async () => {
        await surveyLayer.when();
        const layerView = await view.whenLayerView(surveyLayer);

        try {
          if (!whereClause) {
            status("❌ Missing gid/oid. Open this page via https://aburg55.github.io/survey.html");
            el("result").textContent = "no where clause";
            return;
          }

          const feature = await findFeature(surveyLayer);

          if (!feature) {
            status("⚠️ Submission not found yet. Please refresh once.");
            return;
          }

          if (!feature.geometry) {
            status("✅ Found your submission, but it has no geometry to zoom to.");
            return;
          }

          await view.goTo({ target: feature.geometry, zoom: 18 });

          if (highlightHandle) highlightHandle.remove();
          highlightHandle = layerView.highlight(feature);

          status("✅ Thank you! Submission found + zoomed + highlighted.");
        } catch (e) {
          console.error(e);
          status("❌ Error querying/zooming. Check console.");
        }
      });

    });
  </script>
</body>
</html>
