<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Submission Received</title>

  <link rel="stylesheet" href="https://js.arcgis.com/4.28/esri/themes/light/main.css" />
  <script src="https://js.arcgis.com/4.28/"></script>

  <style>
    html, body, #viewDiv { height: 100%; margin: 0; padding: 0; }
    #message {
      position: absolute;
      top: 15px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255,255,255,0.95);
      padding: 12px 18px;
      border-radius: 6px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.25);
      font-family: Arial, sans-serif;
      z-index: 99;
    }
  </style>
</head>

<body>
  <div id="message">Finalizing your submission…</div>
  <div id="viewDiv"></div>

  <script>
    require([
      "esri/Map",
      "esri/views/MapView"
    ], function (Map, MapView) {

      const msg = document.getElementById("message");

      // Read addr from URL
      const params = new URLSearchParams(window.location.search);
      const addrRaw = params.get("addr");

      if (!addrRaw) {
        msg.innerText = "✅ Submitted — but no address was provided in the redirect URL.";
        return;
      }

      const address = decodeURIComponent(addrRaw).trim();
      console.log("Address from URL:", address);

      // Create map
      const map = new Map({ basemap: "topo-vector" });
      const view = new MapView({ container: "viewDiv", map, zoom: 5 });

      async function geocode(singleLine) {
        // Public ArcGIS World Geocoding endpoint
        const url =
          "https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer/findAddressCandidates" +
          `?SingleLine=${encodeURIComponent(singleLine)}` +
          "&f=pjson&outFields=Match_addr,Addr_type&maxLocations=1";

        const res = await fetch(url);
        if (!res.ok) throw new Error("Geocode request failed");
        const data = await res.json();

        if (!data.candidates || data.candidates.length === 0) return null;
        return data.candidates[0]; // has location {x,y}
      }

      view.when(async () => {
        msg.innerText = "Locating your address…";

        let candidate = null;
        try {
          candidate = await geocode(address);
        } catch (e) {
          console.error(e);
          msg.innerText = "✅ Submitted — but the address lookup failed.";
          return;
        }

        if (!candidate || !candidate.location) {
          msg.innerText = "✅ Submitted — but the address could not be located.";
          return;
        }

        const { x, y } = candidate.location;

        // Add marker
        view.graphics.removeAll();
        view.graphics.add({
          geometry: { type: "point", x, y, spatialReference: { wkid: 4326 } },
          symbol: {
            type: "simple-marker",
            style: "circle",
            size: 18,
            outline: { width: 2 }
          }
        });

        // Zoom
        await view.goTo({ center: [x, y], zoom: 18 });

        msg.innerText = "✅ Thank you! Your submission has been recorded.";
      });

    });
  </script>
</body>
</html>
