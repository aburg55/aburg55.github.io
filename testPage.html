<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Submission Received</title>

  <link
    rel="stylesheet"
    href="https://js.arcgis.com/4.28/esri/themes/light/main.css"
  />
  <script src="https://js.arcgis.com/4.28/"></script>

  <style>
    html, body, #viewDiv {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    #message {
      position: absolute;
      top: 15px;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      padding: 12px 20px;
      border-radius: 6px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.25);
      font-family: Arial, sans-serif;
      z-index: 99;
    }
  </style>
</head>

<body>
  <div id="message">Finalizing your submission…</div>
  <div id="viewDiv"></div>

  <script>
    require([
      "esri/Map",
      "esri/views/MapView",
      "esri/layers/FeatureLayer"
    ], function (Map, MapView, FeatureLayer) {

      // --------------------------------------------------
      // 1️⃣ Get GlobalID from URL
      // --------------------------------------------------
      const params = new URLSearchParams(window.location.search);
      let gid = params.get("gid");

      if (!gid) {
        document.getElementById("message").innerText =
          "Submission ID not found.";
        return;
      }

      // Clean braces if present
      gid = gid.replace("{", "").replace("}", "");
      console.log("Looking for GlobalID:", gid);

      // --------------------------------------------------
      // 2️⃣ Create map + view
      // --------------------------------------------------
      const map = new Map({
        basemap: "topo-vector"
      });

      const view = new MapView({
        container: "viewDiv",
        map: map,
        zoom: 5
      });

      // --------------------------------------------------
      // 3️⃣ MAIN Survey123 Feature Layer (REQUIRED)
      // --------------------------------------------------
      const surveyLayer = new FeatureLayer({
        url: "https://services1.arcgis.com/MEvzxYGCHO108ZxL/arcgis/rest/services/survey123_d4f003f5be254f9bb5a8d92a281f9e13/FeatureServer/0",
        outFields: ["*"]
      });

      map.add(surveyLayer);

      // --------------------------------------------------
      // 4️⃣ OPTIONAL Context Layer (parcels, roads, etc.)
      // --------------------------------------------------
      const contextLayer = new FeatureLayer({
        url: "https://services1.arcgis.com/MEvzxYGCHO108ZxL/arcgis/rest/services/New_Alignments_N211_and_N223/FeatureServer/0",
        opacity: 0.4
      });

      map.add(contextLayer);

      // --------------------------------------------------
      // 5️⃣ Retry / Polling Logic (CRITICAL)
      // --------------------------------------------------
      const MAX_ATTEMPTS = 10;
      const RETRY_DELAY = 800;
      let attempt = 0;

      function queryUntilFound(layer, layerView) {
        attempt++;

        layer.queryFeatures({
          where: `globalid='${gid}'`,
          returnGeometry: true,
          outFields: ["*"]
        }).then((result) => {

          if (result.features.length > 0) {
            const feature = result.features[0];

            view.goTo({
              target: feature.geometry,
              zoom: 18
            });

            layerView.highlight(feature);

            document.getElementById("message").innerText =
              "✅ Thank you! Your submission has been recorded.";

            console.log("Feature found on attempt", attempt);
            return;
          }

          if (attempt < MAX_ATTEMPTS) {
            console.log("Not found yet — retrying", attempt);
            setTimeout(() => queryUntilFound(layer, layerView), RETRY_DELAY);
          } else {
            document.getElementById("message").innerText =
              "Your submission is still processing. Please refresh shortly.";
          }

        }).catch(console.error);
      }

      // --------------------------------------------------
      // 6️⃣ Start once layerView is ready
      // --------------------------------------------------
      view.when(() => {
        view.whenLayerView(surveyLayer).then((layerView) => {
          queryUntilFound(surveyLayer, layerView);
        });
      });

    });
  </script>
</body>
</html>
