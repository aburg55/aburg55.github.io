<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Submission Received</title>

  <link rel="stylesheet" href="https://js.arcgis.com/4.28/esri/themes/light/main.css" />
  <script src="https://js.arcgis.com/4.28/"></script>

  <style>
    html, body, #viewDiv { height: 100%; margin: 0; padding: 0; }
    #message {
      position: absolute;
      top: 15px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255,255,255,0.95);
      padding: 12px 18px;
      border-radius: 6px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.25);
      font-family: Arial, sans-serif;
      z-index: 99;
      max-width: 92vw;
    }
    #sub {
      font-size: 12px;
      opacity: 0.8;
      margin-top: 6px;
      word-break: break-word;
    }
  </style>
</head>

<body>
  <div id="message">
    Finalizing your submission…
    <div id="sub"></div>
  </div>
  <div id="viewDiv"></div>

  <script>
    require([
      "esri/Map",
      "esri/views/MapView",
      "esri/layers/FeatureLayer"
    ], function (Map, MapView, FeatureLayer) {

      const msg = document.getElementById("message");
      const sub = document.getElementById("sub");

      // --- Read addr from URL ---
      const params = new URLSearchParams(window.location.search);
      const addrRaw = params.get("addr");

      if (!addrRaw) {
        msg.innerText = "✅ Submitted — but no address was provided in the redirect URL.";
        return;
      }

      const address = decodeURIComponent(addrRaw).trim();
      sub.textContent = `Address: ${address}`;

      // --- Create map ---
      const map = new Map({ basemap: "topo-vector" });
      const view = new MapView({ container: "viewDiv", map, zoom: 5 });

      // --- Context layer: your Survey123 points ---
      const surveyLayer = new FeatureLayer({
        url: "https://services1.arcgis.com/MEvzxYGCHO108ZxL/arcgis/rest/services/survey123_d4f003f5be254f9bb5a8d92a281f9e13/FeatureServer/0",
        outFields: ["*"],
        opacity: 0.45
      });
      map.add(surveyLayer);

      async function geocode(singleLine) {
        const url =
          "https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer/findAddressCandidates" +
          `?SingleLine=${encodeURIComponent(singleLine)}` +
          "&f=pjson&outFields=Match_addr,Addr_type&maxLocations=1";

        const res = await fetch(url);
        if (!res.ok) throw new Error("Geocode request failed");
        const data = await res.json();
        if (!data.candidates || data.candidates.length === 0) return null;
        return data.candidates[0]; // { location: {x,y}, attributes... }
      }

      async function showMostRecentSurveyPoint() {
        // “Most recent” by highest OBJECTID (works well for hosted layers)
        const oidField = surveyLayer.objectIdField; // usually "objectid"

        const q = surveyLayer.createQuery();
        q.where = "1=1";
        q.returnGeometry = true;
        q.outFields = [oidField];
        q.orderByFields = [`${oidField} DESC`];
        q.num = 1;

        const res = await surveyLayer.queryFeatures(q);
        if (!res.features || res.features.length === 0) return;

        const feature = res.features[0];
        if (!feature.geometry) return;

        // Add a standout graphic for the most recent point
        view.graphics.add({
          geometry: feature.geometry,
          symbol: {
            type: "simple-marker",
            style: "diamond",
            size: 20,
            outline: { width: 2 }
          }
        });

        // Optional: also “dim” the layer to only that one most-recent point:
        // surveyLayer.definitionExpression = `${oidField}=${feature.attributes[oidField]}`;

        sub.textContent += ` | Most recent survey ${oidField}: ${feature.attributes[oidField]}`;
      }

      view.when(async () => {
        msg.firstChild.textContent = "Locating your address…";

        // 1) Geocode + zoom to the entered address
        let candidate = null;
        try {
          candidate = await geocode(address);
        } catch (e) {
          console.error(e);
          msg.firstChild.textContent = "✅ Submitted — but the address lookup failed.";
          return;
        }

        if (!candidate || !candidate.location) {
          msg.firstChild.textContent = "✅ Submitted — but the address could not be located.";
          return;
        }

        const { x, y } = candidate.location;

        // Marker for the entered address
        view.graphics.removeAll();
        view.graphics.add({
          geometry: { type: "point", x, y, spatialReference: { wkid: 4326 } },
          symbol: {
            type: "simple-marker",
            style: "circle",
            size: 18,
            outline: { width: 2 }
          }
        });

        await view.goTo({ center: [x, y], zoom: 18 });

        // 2) Add + emphasize most recent Survey123 point
        try {
          await surveyLayer.when();
          await showMostRecentSurveyPoint();
        } catch (e) {
          console.error("Most recent point query failed:", e);
        }

        msg.firstChild.textContent = "✅ Thank you! Your submission has been recorded.";
      });

    });
  </script>
</body>
</html>
